#jinja2: trim_blocks: True, lstrip_blocks: True
{###########################################
PURPOSE: Configure BGP on OS10 Devices

############################################
Example:
dellos_bgp:
  OS10:
    asn: 12
    router_id: 90.1.1.4
    maxpath_ibgp: 2
    maxpath_ebgp: 2
    ipv4_network:
       - address: 101.1.1.0/30
         delete: False
    ipv6_network:
      - address: "2001:4898:5808:ffa0::/126"
        state: present
    ipv4_neighbor:
       - remote_asn: 11
         ip: 192.168.11.1
         delete: False
    ipv6_neighbor:
      - remote_asn: 14
        ip: 2001:4898:5808:ffa2::1
        state: present
    peer_group:
      - name: peer1
        asn: 6
        subnet: 10.128.3.192/27
    redistribute:
      - route_type: static
        address_type: ipv4
        state: present
    state: present

################################}
{% set bgp_vars = dellos_bgp[hostname] %}
{% if bgp_vars.state is defined and bgp_vars.state == "absent" %}
no router bgp
{% else %}
  {# Add Feature to the switch #}
  {% if bgp_vars.asn is defined and bgp_vars.asn %}
router bgp {{ bgp_vars.asn }}
    {% if bgp_vars.router_id is defined %}
      {% if bgp_vars.router_id %}
 router-id {{ bgp_vars.router_id }}
      {% else %}
 no router-id
      {% endif %}
    {% endif %}

    {% if bgp_vars.maxpath_ebgp is defined and bgp_vars.maxpath_ebgp %}
 maximum-paths ebgp {{ bgp_vars.maxpath_ebgp }}
    {% else %}
 no maximum-paths ebgp
    {% endif %}

    {% if bgp_vars.maxpath_ibgp is defined and bgp_vars.maxpath_ibgp %}
 maximum-paths ibgp {{ bgp_vars.maxpath_ibgp }}
    {% else %}
 no maximum-paths ibgp
    {% endif %}

    {% if bgp_vars.ipv4_network is defined and bgp_vars.ipv4_network %}
 address-family ipv4 unicast
      {% for net in bgp_vars.ipv4_network %}
        {% if net.address is defined and net.address %}
          {% if net.state is defined and net.state == "absent"%}
  no network {{ net.address }}
          {% else %}
  network {{ net.address }}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if bgp_vars.ipv6_network is defined and bgp_vars.ipv6_network %}
 address-family ipv6 unicast
      {% for net in bgp_vars.ipv6_network %}
        {% if net.address is defined and net.address %}
          {% if net.state is defined and net.state == "absent"%}
  no network {{ net.address }}
          {% else %}
  network {{ net.address }}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if bgp_vars.redistribute is defined and bgp_vars.redistribute %}
      {% for route in bgp_vars.redistribute %}
        {% if route.route_type is defined  and route.route_type %}
          {% if route.address_type is defined and route.address_type %}
 address-family {{ route.address_type }} unicast
            {% if route.state is defined and route.state == "absent" %}
  no redistribute {{ route.route_type }}
            {% else %}
  redistribute {{ route.route_type }}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if bgp_vars.ipv4_neighbor is defined and bgp_vars.ipv4_neighbor %}
      {% for neighbor in bgp_vars.ipv4_neighbor %}
        {% if neighbor.remote_asn is defined and neighbor.remote_asn %}
          {% if neighbor.ip is defined and neighbor.ip %}
            {% if neighbor.state is defined and neighbor.state == "absent" %}
 no neighbor {{ neighbor.ip }}
            {% else %}
 neighbor {{ neighbor.ip }}
  remote-as {{ neighbor.remote_asn }}
              {% if neighbor.timer is defined %}
                {% if neighbor.timer %}
  timers {{ neighbor.timer }}
                {% else %}
  no timers
                {% endif %}
              {% endif %}
              {% if neighbor.peergroup is defined and neighbor.peergroup %}
                {% if neighbor.peergroup_state is defined and neighbor.peergroup_state == "absent" %}
  inherit template {{ neighbor.peergroup }}
                {% else %}
  no inherit template {{ neighbor.peergroup }}
                {% endif %}
              {% endif %}
  no shutdown
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if bgp_vars.peer_group is defined and bgp_vars.peer_group %}
      {% for net in bgp_vars.peer_group %}
        {% if net.name is defined and net.name %}
        {# Create peer-group #}
          {% if net.state is defined and net.state == "absent" %}
 no template {{ net.name }} 
          {% else %}
 template {{ net.name }}
            {% if net.passive is defined and net.passive %}
              {% if net.subnet is defined and net.subnet %}
  listen {{ net.subnet }}
              {% endif %}
            {% endif %}
            {% if net.asn is defined and net.asn %}
  remote-as {{ net.asn }}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

  {% endif %}
{% endif %}

